<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <link rel="stylesheet" href="/styles/PageTemplate.css">
    <link rel="stylesheet" href="/admin-users.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-users-cog"></i> User Management</h1>
            <button class="btn btn-primary" onclick="showCreateUserModal()">
                <i class="fas fa-user-plus"></i> Create Account
            </button>
        </div>

        <!-- Users Table -->
        <div class="users-table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>User Tag</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each users}}
                    <tr data-user-id="{{_id}}">
                        <td>
                            <div class="user-cell">
                                <img src="{{profilePic}}" alt="{{username}}" class="user-avatar">
                                <strong>{{username}}</strong>
                            </div>
                        </td>
                        <td>
                            <span class="role-badge role-{{role}}">{{role}}</span>
                        </td>
                        <td>{{userTag}}</td>
                        <td>
                            {{#if isRestricted}}
                                <span class="status-badge status-restricted">
                                    <i class="fas fa-ban"></i> Restricted
                                </span>
                            {{else}}
                                <span class="status-badge status-active">
                                    <i class="fas fa-check-circle"></i> Active
                                </span>
                            {{/if}}
                        </td>
                        <td>{{formatDate createdAt}}</td>
                        <td>{{formatDate lastLogin}}</td>
                        <td>
                            <div class="action-buttons">
                                {{#if isRestricted}}
                                    <button class="btn-small btn-success" onclick="unbanUser('{{_id}}', '{{username}}')">
                                        <i class="fas fa-unlock"></i> Unrestrict
                                    </button>
                                {{else}}
                                    <button class="btn-small btn-warning" onclick="showRestrictModal('{{_id}}', '{{username}}')">
                                        <i class="fas fa-clock"></i> Restrict
                                    </button>
                                    <button class="btn-small btn-danger" onclick="showBanModal('{{_id}}', '{{username}}')">
                                        <i class="fas fa-ban"></i> Ban
                                    </button>
                                {{/if}}
                                
                                <button class="btn-small btn-info" onclick="changeRole('{{_id}}', '{{username}}', '{{role}}')">
                                    <i class="fas fa-user-tag"></i> Change Role
                                </button>
                                
                                {{#unless (eq role 'administrator')}}
                                    <button class="btn-small btn-danger" onclick="showDeleteModal('{{_id}}', '{{username}}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                {{/unless}}
                            </div>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Create New Account</h2>
                <span class="close" onclick="closeCreateUserModal()">&times;</span>
            </div>
            <form id="createUserForm" onsubmit="createUser(event)">
                <div class="form-group">
                    <label for="newUserRole">
                        <i class="fas fa-shield-alt"></i> Account Type
                    </label>
                    <select id="newUserRole" required onchange="toggleManagedTagsField()">
                        <option value="manager">Manager</option>
                        <option value="administrator">Administrator</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newUsername">
                        <i class="fas fa-user"></i> Username
                    </label>
                    <input type="text" id="newUsername" required 
                           placeholder="Enter username" 
                           pattern="[a-zA-Z0-9_]{3,20}"
                           title="3-20 characters, letters, numbers, and underscores only">
                </div>
                
                <div class="form-group">
                    <label for="newPassword">
                        <i class="fas fa-lock"></i> Password
                    </label>
                    <input type="password" id="newPassword" required 
                           placeholder="Enter password"
                           minlength="8"
                           oninput="validatePasswordStrength()">
                    <div id="passwordRequirements" class="password-requirements">
                        <div class="requirement" id="req-length">
                            <i class="fas fa-circle"></i> At least 8 characters
                        </div>
                        <div class="requirement" id="req-uppercase">
                            <i class="fas fa-circle"></i> One uppercase letter
                        </div>
                        <div class="requirement" id="req-lowercase">
                            <i class="fas fa-circle"></i> One lowercase letter
                        </div>
                        <div class="requirement" id="req-number">
                            <i class="fas fa-circle"></i> One number
                        </div>
                        <div class="requirement" id="req-special">
                            <i class="fas fa-circle"></i> One special character (!@#$%^&*()_+-=[]{}|)
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newUserTag">
                        <i class="fas fa-tag"></i> User Tag
                    </label>
                    <input type="text" id="newUserTag" required 
                           placeholder="u/username">
                </div>
                
                <div class="form-group">
                    <label for="newSecurityQuestion">
                        <i class="fas fa-question-circle"></i> Security Question
                    </label>
                    <select id="newSecurityQuestion" required>
                        <option value="">Select a security question</option>
                        <option value="What is your favorite color?">What is your favorite color?</option>
                        <option value="What city were you born in?">What city were you born in?</option>
                        <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
                        <option value="What was the name of your first pet?">What was the name of your first pet?</option>
                        <option value="What is your favorite food?">What is your favorite food?</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newSecurityAnswer">
                        <i class="fas fa-key"></i> Security Answer
                    </label>
                    <input type="text" id="newSecurityAnswer" required 
                           placeholder="Enter security answer">
                    <small>This will be used for password recovery</small>
                </div>
                
                <div class="form-group" id="managedTagsGroup">
                    <label for="newManagedTags">
                        <i class="fas fa-tags"></i> Managed Tags (comma-separated)
                    </label>
                    <input type="text" id="newManagedTags" 
                           placeholder="e.g., Food, Travel, Gaming">
                    <small>Optional: Tags this manager can moderate</small>
                </div>
                
                <button type="submit" class="btn btn-primary btn-full">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </form>
        </div>
    </div>

    <!-- Ban User Modal -->
    <div id="banModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-ban"></i> Permanently Ban User</h2>
                <span class="close" onclick="closeBanModal()">&times;</span>
            </div>
            <form id="banForm" onsubmit="submitBan(event)">
                <div class="form-group">
                    <label>Username: <strong id="banUsername"></strong></label>
                </div>
                
                <div class="form-group">
                    <label for="banReason">
                        <i class="fas fa-exclamation-circle"></i> Reason for Ban
                    </label>
                    <textarea id="banReason" required rows="3" 
                              placeholder="Enter the reason for this permanent ban"></textarea>
                </div>
                
                <div style="background: #ff5252; color: white; padding: 12px; border-radius: 4px; margin: 15px 0;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This will permanently ban the user from the platform.
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeBanModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-danger" style="flex: 1;">
                        <i class="fas fa-ban"></i> Permanently Ban User
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Restrict User Modal -->
    <div id="restrictModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-clock"></i> Temporarily Restrict User</h2>
                <span class="close" onclick="closeRestrictModal()">&times;</span>
            </div>
            <form id="restrictForm" onsubmit="submitRestrict(event)">
                <div class="form-group">
                    <label>Username: <strong id="restrictUsername"></strong></label>
                </div>
                
                <div class="form-group">
                    <label for="restrictDuration">
                        <i class="fas fa-hourglass-half"></i> Restriction Duration
                    </label>
                    <select id="restrictDuration" required>
                        <option value="1">1 Hour</option>
                        <option value="6">6 Hours</option>
                        <option value="12">12 Hours</option>
                        <option value="24">24 Hours (1 Day)</option>
                        <option value="48" selected>48 Hours (2 Days)</option>
                        <option value="72">72 Hours (3 Days)</option>
                        <option value="168">1 Week</option>
                        <option value="336">2 Weeks</option>
                        <option value="720">30 Days</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="restrictReason">
                        <i class="fas fa-exclamation-circle"></i> Reason for Restriction
                    </label>
                    <textarea id="restrictReason" required rows="3" 
                              placeholder="Enter the reason for this temporary restriction"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeRestrictModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-warning" style="flex: 1;">
                        <i class="fas fa-clock"></i> Restrict User
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-trash"></i> Delete User Account</h2>
                <span class="close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <form id="deleteForm" onsubmit="submitDelete(event)">
                <div class="form-group">
                    <label>Username: <strong id="deleteUsername"></strong></label>
                </div>
                
                <div class="form-group">
                    <label for="deleteConfirm">
                        <i class="fas fa-keyboard"></i> Type the username to confirm deletion
                    </label>
                    <input type="text" id="deleteConfirm" required 
                           placeholder="Type username here">
                </div>
                
                <div style="background: #ff5252; color: white; padding: 12px; border-radius: 4px; margin: 15px 0;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-danger" style="flex: 1;">
                        <i class="fas fa-trash"></i> Delete Account
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="/admin-users.js"></script>
</body>
</html>
